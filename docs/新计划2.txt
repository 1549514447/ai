# ğŸš€ `intelligent_qa_orchestrator.py` é‡æ„è®¡åˆ’

## ğŸ“‹ å½“å‰é—®é¢˜åˆ†æ

### **è¢«åˆ é™¤çš„ä¾èµ–**ï¼š
```python
# âŒ å·²åˆ é™¤ï¼Œéœ€è¦ç§»é™¤å¼•ç”¨
from core.analyzers.financial_data_analyzer import FinancialDataAnalyzer
from core.analyzers.insight_generator import InsightGenerator
from core.analyzers.data_requirements_analyzer import DataRequirementsAnalyzer
```

### **å†—ä½™çš„å¤„ç†æ­¥éª¤**ï¼š
```python
# âŒ å½“å‰æµç¨‹è¿‡äºå¤æ‚
# Step 1: Claude ç†è§£æŸ¥è¯¢
# Step 2: è·å–æ•°æ®
# Step 3: è®¡ç®—å¤„ç†
# Step 4: ç”Ÿæˆæ´å¯Ÿ â† å·²åˆ é™¤insight_generator
# Step 5: Claude ç”Ÿæˆæœ€ç»ˆå›ç­”
# Step 6: ç”Ÿæˆå¯è§†åŒ–
```

---

## ğŸ¯ æ–°æ¶æ„è®¾è®¡

### **ç²¾ç®€åçš„ç»„ä»¶**ï¼š
```python
# âœ… ä¿ç•™çš„æ ¸å¿ƒç»„ä»¶
self.query_parser: SmartQueryParser          # Claudeç†è§£&å†³ç­–
self.data_fetcher: SmartDataFetcher          # APIè°ƒç”¨
self.statistical_calculator: UnifiedCalculator # GPTè®¡ç®—
# âŒ åˆ é™¤å…¶ä»–æ‰€æœ‰ç»„ä»¶
```

### **ç®€åŒ–æµç¨‹**ï¼š
```python
async def process_intelligent_query():
    # 1ï¸âƒ£ Claudeç†è§£&å†³ç­–
    query_analysis = await self.query_parser.parse_complex_query(query)

    # 2ï¸âƒ£ æ‰§è¡ŒAPIè°ƒç”¨
    data_result = await self.data_fetcher.execute_api_calls(query_analysis.api_calls_needed)

    # 3ï¸âƒ£ GPTè®¡ç®—(å¦‚éœ€è¦)
    if query_analysis.needs_calculation:
        calc_result = await self.statistical_calculator.calculate(...)

    # 4ï¸âƒ£ Claudeç”Ÿæˆæœ€ç»ˆå›ç­”
    response = await self._claude_generate_final_response(query, data_result, calc_result)

    return ProcessingResult(...)
```

---

## ğŸ“ é‡æ„å®æ–½

### **Phase 1: æ¸…ç†importså’Œåˆå§‹åŒ–**

```python
# ğŸ†• ç®€åŒ–ç‰ˆimports
from core.analyzers.query_parser import SmartQueryParser, create_smart_query_parser
from core.data_orchestration.smart_data_fetcher import SmartDataFetcher, create_smart_data_fetcher
from utils.calculators.statistical_calculator import UnifiedCalculator, create_unified_calculator
# âŒ åˆ é™¤å…¶ä»–analyzer imports

class IntelligentQAOrchestrator:
    def _initialize_component_placeholders(self):
        """ğŸ¯ å¤§å¹…ç®€åŒ–çš„ç»„ä»¶åˆå§‹åŒ–"""
        # âœ… æ ¸å¿ƒä¸‰å‰‘å®¢
        self.query_parser: Optional[SmartQueryParser] = None
        self.data_fetcher: Optional[SmartDataFetcher] = None
        self.statistical_calculator: Optional[UnifiedCalculator] = None

        # âœ… å·¥å…·ç»„ä»¶
        self.date_utils: Optional[DateUtils] = None
        self.financial_formatter: Optional[FinancialFormatter] = None
        self.conversation_manager: Optional[ConversationManager] = None

        # âŒ åˆ é™¤æ‰€æœ‰analyzerç»„ä»¶
```

### **Phase 2: é‡æ„æ ¸å¿ƒå¤„ç†æ–¹æ³•**

```python
async def process_intelligent_query(self, user_query: str, user_id: int = 0,
                                    conversation_id: Optional[str] = None,
                                    preferences: Optional[Dict[str, Any]] = None) -> ProcessingResult:
    """ğŸ¯ æç®€ç‰ˆæ™ºèƒ½æŸ¥è¯¢å¤„ç†"""

    session_id = str(uuid.uuid4())
    query_id = f"q_{datetime.now().strftime('%Y%m%d%H%M%S%f')}_{hashlib.md5(user_query.encode()).hexdigest()[:6]}"
    start_time = time.time()

    try:
        # 1ï¸âƒ£ Claudeç†è§£&å†³ç­– (ä¸€æ­¥åˆ°ä½)
        query_analysis = await self.query_parser.parse_complex_query(user_query, context)

        # 2ï¸âƒ£ æ‰§è¡ŒAPIè°ƒç”¨
        data_result = await self._execute_api_calls(query_analysis.api_calls_needed)

        # 3ï¸âƒ£ GPTè®¡ç®— (å¦‚éœ€è¦)
        calculation_result = None
        if query_analysis.needs_calculation:
            calculation_result = await self._execute_calculation(query_analysis, data_result)

        # 4ï¸âƒ£ Claudeç”Ÿæˆæœ€ç»ˆå›ç­” (åŸºäºæ‰€æœ‰æ•°æ®)
        response_text = await self._claude_generate_final_response(
            user_query, query_analysis, data_result, calculation_result
        )

        # ğŸ¯ æ„å»ºç®€åŒ–çš„ç»“æœ
        return ProcessingResult(
            session_id=session_id,
            query_id=query_id,
            success=True,
            response_text=response_text,
            key_metrics=self._extract_key_metrics(data_result, calculation_result),
            processing_strategy=self._determine_strategy(query_analysis),
            confidence_score=query_analysis.confidence_score,
            total_processing_time=time.time() - start_time,
            # âŒ åˆ é™¤insightsã€visualizationsç­‰å¤æ‚å­—æ®µ
        )

    except Exception as e:
        return self._create_error_result(str(e), user_query, query_id)
```

### **Phase 3: é‡å†™è¾…åŠ©æ–¹æ³•**

```python
async def _execute_api_calls(self, api_calls: List[Dict[str, Any]]) -> Dict[str, Any]:
    """æ‰§è¡ŒAPIè°ƒç”¨ - ç›´æ¥è°ƒç”¨data_fetcher"""
    try:
        # ğŸ¯ ç›´æ¥æ‰§è¡Œï¼Œä¸éœ€è¦å¤æ‚çš„ç­–ç•¥åˆ†æ
        return await self.data_fetcher.execute_api_calls_batch(api_calls)
    except Exception as e:
        logger.error(f"APIè°ƒç”¨å¤±è´¥: {e}")
        return {"success": False, "error": str(e)}

async def _execute_calculation(self, query_analysis, data_result) -> Dict[str, Any]:
    """æ‰§è¡Œè®¡ç®— - è°ƒç”¨ç»Ÿä¸€è®¡ç®—å™¨"""
    try:
        calc_data = self._prepare_calculation_data(data_result)
        calc_params = self._extract_calculation_params(query_analysis)

        # ğŸ¯ ä½¿ç”¨ç»Ÿä¸€è®¡ç®—å™¨
        calc_result = await self.statistical_calculator.calculate(
            calculation_type=query_analysis.calculation_type,
            data=calc_data,
            params=calc_params
        )

        return {
            'success': calc_result.success,
            'result': calc_result,
            'calculation_type': query_analysis.calculation_type
        }
    except Exception as e:
        logger.error(f"è®¡ç®—å¤±è´¥: {e}")
        return {"success": False, "error": str(e)}

async def _claude_generate_final_response(self, user_query: str,
                                         query_analysis, data_result, calc_result) -> str:
    """ğŸ¯ Claudeç”Ÿæˆæœ€ç»ˆå›ç­” - åŸºäºæ‰€æœ‰ä¿¡æ¯"""
    if not self.claude_client:
        return self._generate_fallback_response(user_query, data_result, calc_result)

    # æ„å»ºå®Œæ•´ä¸Šä¸‹æ–‡ç»™Claude
    context = {
        "user_query": user_query,
        "query_type": query_analysis.query_type.value,
        "data_summary": self._summarize_data(data_result),
        "calculation_summary": self._summarize_calculation(calc_result) if calc_result else None,
        "confidence": query_analysis.confidence_score
    }

    prompt = f"""
ä½œä¸ºä¸“ä¸šAIé‡‘èåŠ©æ‰‹ï¼ŒåŸºäºä»¥ä¸‹ä¿¡æ¯ä¸ºç”¨æˆ·ç”Ÿæˆå®Œæ•´ã€å‡†ç¡®çš„ä¸­æ–‡å›ç­”ï¼š

ç”¨æˆ·æŸ¥è¯¢ï¼š"{user_query}"

å¯ç”¨ä¿¡æ¯ï¼š
{json.dumps(context, ensure_ascii=False, indent=2)}

è¦æ±‚ï¼š
1. ç›´æ¥å›ç­”ç”¨æˆ·æ ¸å¿ƒé—®é¢˜
2. çªå‡ºå…³é”®æ•°æ®å’Œå‘ç°
3. å¦‚æœ‰è®¡ç®—ç»“æœï¼Œæ¸…æ¥šè§£é‡Šå«ä¹‰
4. æä¾›å®ç”¨çš„ä¸šåŠ¡å»ºè®®
5. è¯­è¨€ä¸“ä¸šä¸”æ˜“æ‡‚
6. æ§åˆ¶åœ¨300-600å­—

è¯·ç”Ÿæˆå›ç­”ï¼š
"""

    result = await self.claude_client.generate_text(prompt, max_tokens=1500)

    if result and result.get('success'):
        return result.get('text', '').strip()
    else:
        return self._generate_fallback_response(user_query, data_result, calc_result)
```

---

## ğŸ—‘ï¸ éœ€è¦åˆ é™¤çš„æ–¹æ³•

```python
# âŒ åˆ é™¤æ‰€æœ‰ä¸å·²åˆ é™¤ç»„ä»¶ç›¸å…³çš„æ–¹æ³•
async def _generate_insights()           # insight_generatorç›¸å…³
async def _analyze_business_performance() # financial_data_analyzerç›¸å…³
async def _detect_anomalies()           # financial_data_analyzerç›¸å…³
async def _generate_visualizations()    # å¤æ‚å¯è§†åŒ–é€»è¾‘
```

---

## ğŸ“Š ç®€åŒ–çš„æ•°æ®ç»“æ„

### **ProcessingResult (ç®€åŒ–ç‰ˆ)**ï¼š
```python
@dataclass
class ProcessingResult:
    # ä¿ç•™æ ¸å¿ƒå­—æ®µ
    session_id: str
    query_id: str
    success: bool
    response_text: str
    key_metrics: Dict[str, Any] = field(default_factory=dict)
    confidence_score: float = 0.0
    total_processing_time: float = 0.0
    processing_strategy: ProcessingStrategy = ProcessingStrategy.SIMPLE_DATA

    # âŒ åˆ é™¤å¤æ‚å­—æ®µ
    # insights: List[BusinessInsight] = field(default_factory=list)
    # visualizations: List[Dict[str, Any]] = field(default_factory=list)
    # ai_collaboration_summary: Dict[str, Any] = field(default_factory=dict)
```

---

## âš¡ é¢„æœŸæ•ˆæœ


### **æ€§èƒ½æå‡**ï¼š
- **AIè°ƒç”¨æ¬¡æ•°**: ä»3-4æ¬¡å‡å°‘åˆ°2æ¬¡ (Claudeç†è§£ + Claudeå›ç­”)
- **å¤„ç†æ­¥éª¤**: ä»6æ­¥å‡å°‘åˆ°4æ­¥
- **å“åº”æ—¶é—´**: é¢„è®¡æå‡40-60%

### **ç»´æŠ¤æ€§**ï¼š
- **èŒè´£æ¸…æ™°**: Claudeä¸“æ³¨è¯­è¨€ï¼ŒGPTä¸“æ³¨è®¡ç®—
- **æµç¨‹ç®€å•**: çº¿æ€§æµç¨‹ï¼Œæ˜“äºè°ƒè¯•
- **é”™è¯¯å¤„ç†**: ç®€åŒ–é”™è¯¯ä¼ æ’­è·¯å¾„

è¿™æ ·çš„é‡æ„å®Œå…¨ç¬¦åˆä½ çš„**"Claudeä¸»å¯¼ + GPTè®¡ç®—"**æ¶æ„ç›®æ ‡ï¼ğŸ¯